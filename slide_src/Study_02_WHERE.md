---
marp: true
theme: base
paginate: true
footer: SQL 勉強会 WHERE
---

# SQL 勉強会 WHERE
今回はSELECT時に条件を指定するWHEREを学びます。WHERE単独で1つの章にしていますが条件の種類が多彩なので量は多いです。
全てを覚える必要はありませんが後で調べられるように概念だけは掴んでおいください。

---

# WHERE 概要
WHERE句で検索条件を指定することで条件にあったデータだけを抽出することが出来るようになります。WHERE句には真偽値が得られる評価式を記載します。
categoryテーブルでidが5以下のデータだけを抽出するには下記のようにします。

```sql
SELECT
  *
FROM
  category
WHERE
  category_id <= 5
;
```

---

# WHERE 概要

|category_id|name|last_update|
|---|---|---|
|1|Action      | 2006-02-15 09:46:27 |
|2|Animation   | 2006-02-15 09:46:27 |
|3|Children    | 2006-02-15 09:46:27 |
|4|Classics    | 2006-02-15 09:46:27 |
|5|Comedy      | 2006-02-15 09:46:27 |

---

# WHERE 概要 補足
LIMITでも同じことが出来るじゃんと思われたかもしれませんが、一般にSQLでORDER BYをしない場合は順不同でSELECTされます。順序がバラバラの状態で上からN件取得すると実行結果が固定されないので注意してください。
経験上インデックスを張っていればインデックス順になるような気がしますが、その辺りは扱いませんし順序が重要になる場合はORDER BYを使いましょう。いずれこの勉強会でも扱います。

---

# WHERE 概要 補足

順序が重要じゃないときってどんなとき？と思われるかもしれませんが、SQLではサブクエリと言って一時的に取得したデータと〇〇テーブルを結合するみたいなことが出来ます。最終的に結合したデータでソートするのにサブクエリ内でソートすると(たぶんほぼすべての状況で)無駄になるので最終的にソートするときに中間のデータはソートしないほうが良いです。EDAやクエリの検証中に一度書いたSQLをコピーしてサブクエリにするってことが良くあると思いますが、無駄なソートは省くようにしましょう。一度実行したクエリであればDBキャッシュが作られている可能性もあるので必ず遅くなるわけではないですが、無駄なことは省く癖をつけましょう。

---

# WHERE 比較演算子

先程の例では〇〇以下としたように、比較演算子で条件を指定することが出来ます。当然数値以外の比較も可能です。

```sql
SELECT
  *
FROM
  category
WHERE
  name = 'Action'
;
```

---

# WHERE 比較演算子
時刻も比較可能です。

```sql
SELECT
  *
FROM
  category
WHERE
  last_update < '2006-02-15 09:46:28'
;
```

---

# WHERE 比較演算子
特定の時刻を指定することもありますが、INTERVALを使って現在時刻から指定した期間だけ前とかの指定をすることが出来るので覚えておきましょう。ここ最近のデータだけみたいというときには下記のようにします。1時間とかでも複数形にしてOKです。

```sql
SELECT
  *
FROM
  category
WHERE
  last_update < CURRENT_TIMESTAMP - INTERVAL '1 hours'
;
```

---

# WHERE 複数条件
当然複数の条件を組み合わせて絞り込み条件とすることも出来ます。多くのプログラミング言語と同じようにANDやORで条件を結合させます。他の言語同様にANDが優先なので必要に応じてカッコでくくる必要があります。
例えば A OR B AND C は意味として A OR (B AND C) と同じです。 A OR B AND C は A OR (B AND C) となるので注意が必要です。 A OR Bを先に評価させたいときは (A OR B) AND C としましょう。

```sql
SELECT
  *
FROM
  category
WHERE
  last_update = '2006-02-15 09:46:27'
AND
  name = 'Action'
;
```

---

# WHERE IN
絞り込みをするときに名称がこれらの中に含まれるときって条件を作りたくなると思います。そんなときにORをひたすら続けることも可能ではありますが、IN句を使うことで簡単に書けるようになります。

```sql
SELECT
  *
FROM
  category
WHERE
  name IN (
    'Action'
    , 'Animation'
  )
;
```

IN句の使い方としてサブクエリと組み合わせることがよくあります。IN句に入れたいIDや名称などをクエリで取得することで動的な絞り込みが可能になります。

---

# WHERE IN サブクエリ
```sql
SELECT
  title
  , category
  , length
FROM
  film_list
WHERE
  length < 60
AND
  category IN (
    SELECT
      name
    FROM
      category
    WHERE
      category_id > 10
  )
;
```

---

# WHERE IN サブクエリ 補足
NOT IN とすることで含まないものを検索するとすることは出来ますが、重くなりがちなのでなるべく避けるようにしたほうが良いそうです。今回のデータセットくらいであればさほど遅くならないと思いますが否定形を検索条件に利用すると重くなりやすいことは知っておいてください。
サブクエリはWITH句と組み合わせることで一つのクエリの中で何度も使い回すことが出来るようになります。いずれ扱う予定です。
サブクエリは一度書いたクエリをついついコピペしがちで非効率なクエリを生み出しやすいです。使い捨てのクエリであればまぁ良いかもしれませんがさっき使ったクエリでカラムだけ変えてそのまま再利用しよう、ここはこの前書いた〜と考えなしで過去のクエリを使うと同じデータを1つのクエリで何度も取得したり非効率なSELECTになるので注意してください。ここまでのことはなかなかしないと思いますが、わかりやすい非効率な例を次のスライドで出します。

---

# WHERE IN サブクエリ 補足

```sql
SELECT
  *
FROM
  category
WHERE
  name IN (
    SELECT
      name
    FROM
      category
    WHERE
      category_id < 5
  )
;
```

この例ではnameのリストとしてcategory_idが5未満のnameを取得していますが、これは結局category_idが5未満を条件にすれば良いですよね。これは極端ですが考えなしのコピペは無駄を生みがちなので注意しましょう。

---

# WHERE LIKE

絞り込み条件で名称が〇〇で始まるものだけ取得したいとか文字列で検索したいんだけど完全一致するものって条件じゃなく検索したい場合はLIKEとワイルドカードを使います。
〇〇で始まるとか終わるみたいな検索条件を作ることが出来ます。

|任意の文字(0字以上)|任意の1文字|
|---|---|
| % | _ |

---

# WHERE LIKE

%は0文字でも良いので%を除外した検索文字列とも一致します。 _ は任意の1文字なので検索文字列とは一致しません。0埋め文字とかで使いますね。

```sql
Introduct% -- Introduct, Introduction, Introduct.*にヒット
Study_0_ -- Study_01, Study_02, Study_0a にヒット
```

```sql
SELECT
  *
FROM
  category
WHERE
  name LIKE 'A%'
;
```

当然否定形も使えるのでNOT LIKEも使えますが例によって否定形を使うときは注意しましょう。

