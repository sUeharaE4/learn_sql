---
marp: true
theme: base
paginate: true
footer: SQL 勉強会 SELECT, FROM and LIMIT
---

# SQL 勉強会 SELECT, FROM and LIMIT
今回はDBからデータを取得するために必要な最も基本となるSELECTとFROMを扱います。LIMITはついでです。
内容は簡単なのでSQLを書くことに慣れることを意識して取り組んでください。psqlの使い方にも慣れましょう。

---

# SELECT 概要
テーブルから(以外からも)データを引いてくるときにはSELECTを使います。
例えば固定値や現在時間を取得することが出来ますし、特定のテーブルから指定したカラムのデータを取得することも出来ます。
ここではまずテーブルを指定しない例をあげます。テーブルはFROM句で扱うのでもう少し待ってください。また、文字列はシングルクォートで囲う必要があるので注意してください。

```sql
SELECT 1, 'str needs quote';
```

```sql
 ?column? |    ?column?
----------+-----------------
        1 | str needs quote
```

---
# SELECT 概要

```sql
SELECT
  CURRENT_DATE AS date_format
  , CURRENT_TIME AS time_format
  , CURRENT_TIMESTAMP AS timestamp_format; -- NOW()とCURRENT_TIMESTAMPは同等
```

```
 date_format |    time_format     |       timestamp_format
-------------+--------------------+-------------------------------
 2021-11-06  | 06:29:47.568009+00 | 2021-11-06 06:29:47.568009+00
(1 row)
```

この例で使った現在時刻を取得するコマンドはPostgreSQLのものです。他のDBでは異なるので注意してください。また、ASを使うとカラムに別名を付けることが出来ます。実はカラム以外にも別名をつけれるのでいずれ扱います。

---

# 自分でやってみよう
まだFROMが使えないのであまりおもしろくないかもしれませんが、なにか定数を取得するSQLを書いてみましょう。
また、PostgreSQLのすでに用意されているコマンドを調べてタイムゾーンや文字コード設定などを取得してみましょう。

---

# FROM 概要
SELECTでテーブルからデータを取得するためにはFROM句で対象のテーブルを指定します。厳密にはテーブル以外にも指定出来ますがとりあえず最初はテーブルから取得するものだと思ってください。
今回のデータセットは小さいですが一応予めテーブル件数を確認する方法も記載しておきます。COUNT(カラム名)とすることでNULLでないレコード数を取得することが出来ます。
ここはどのカラムに欠損がどの程度あるかわからないので全カラムを表す「\*」とすることが多いです。欠損が多いカラムを指定してCOUNTした結果実際のレコード数よりかなり少なくデータ量を見積もってしまったみたいな事故も防げますし欠損がない行数を取得したいなど特に理由がなければ「\*」を指定するのが良いと思います。

---

# FROM テーブル件数の確認

試しにactorテーブルの件数を確認してみましょう。
```sql
SELECT COUNT(*) FROM actor;
```

```sql
 count
-------
   200
(1 row)
```

---

# FROM 特定テーブルのデータを取得

actorテーブルはそこそこ多いのでcategoryテーブルを使うことにしましょう。まずcategoryテーブルから全データを取得するには下記のようにします。

```sql
SELECT
  *
FROM
  category
;
```

---

# FROM 特定テーブルのデータを取得

|category_id|name|last_update|
|---|---|---|
|1|Action      | 2006-02-15 09:46:27 |
|2|Animation   | 2006-02-15 09:46:27 |
|3|Children    | 2006-02-15 09:46:27 |
|4|Classics    | 2006-02-15 09:46:27 |
|5|Comedy      | 2006-02-15 09:46:27 |
|6|Documentary | 2006-02-15 09:46:27 |
|7|Drama       | 2006-02-15 09:46:27 |
|8|Family      | 2006-02-15 09:46:27 |
|9|Foreign     | 2006-02-15 09:46:27 |
|10|Games       | 2006-02-15 09:46:27 |
|11|Horror      | 2006-02-15 09:46:27 |
|12|Music       | 2006-02-15 09:46:27 |
|13|New         | 2006-02-15 09:46:27 |
|14|Sci-Fi      | 2006-02-15 09:46:27 |
|15|Sports      | 2006-02-15 09:46:27 |
|16|Travel      | 2006-02-15 09:46:27 |

↑この後の説明で使うので表形式にしました。このようにカテゴリはidと名称と更新日時を保持しています。

---
# FROM SELECT句で必要なカラムを指定する

また、全カラムの情報が必要ない場合に指定したカラムのみ取得することも可能です。例えばactor_infoテーブルはfilm_infoが長い文字列なのでターミナルで折り返しが発生します。
折り返しは本質ではないのですが、必要な情報だけ取るようにしておくと良いです。特にプログラムと連携するときやGrafanaなどのBIツールにデータを渡すときには余計な情報を入れると受け取った側で利用する項目を選択しなければならなくなります。
ただ、「\*」で取得しておけばカラム追加でSQLは改修不要になるから「\*」で取得しようという思想もあるとは思うので、ルールに従いましょう。

---

# FROM SELECT句で必要なカラムを指定する

特定のカラムだけ選択して取得するにはSELECT句に必要なカラムを記載します。改行やインデントは無くても良いです。インデントの入れ方やカンマを前に入れるか後ろに入れるかは意見がわかれます。ルールに従いましょう。私は特に指定がなければ先にカンマを入れます。後ろに入れると行複製してカラム名を書き換えることで取得対象を追加しようとしたときに最終行のカンマを消し忘れるからです。
あ、当然ですが指定がなくても既存の実装に合わせるようにしてください。ルールがないからって統一感無視して独自路線に進むと徐々に品質を保とうという意識が薄れていきます。自分は大丈夫だと思っていても他の人が鉄の意志を持っているとは限りません。

---

# FROM SELECT句で必要なカラムを指定する

下記SQLは実行するとそこそこのレコード数を取得するので途中まで表示してEnterを押すと更に表示される状態になると思います。これをやめたいときはクライアントによりますがpsqlであれば「q」を押してください。

```sql
SELECT
  actor_id
  , first_name
  , last_name
FROM
  actor_info
;
```

---

# FROM テーブル一覧の確認

PostgreSQLのコマンドでテーブル一覧やテーブル定義を確認するには「\d」や「\d テーブル名」を使います。DBによってコマンドが異なるので注意してください。
ちなみに「\d」はviewやsequenceも含みます。純粋にテーブル名だけ知りたいときは「\dt」とします。

---

# 自分でやってみよう

任意のテーブルからSELECTしてみましょう。レコード数が多いときはqで抜けるのも忘れずに。
ちなみに複数のテーブルをFROM句に指定することも可能です。その場合はカラムを複数指定したときと同じようにカンマ区切りでテーブル名を指定します。今はあまり意味のある出力が得られませんがこの先GROUP BYなどを使えるようになると活用できるので、頭の片隅に入れておいてください。
staff, store, languageあたりのレコード数が少ないテーブルでやってみましょう。

---

# LIMIT 概要

SELECTで取得するレコードのうち指定した件数だけ出力するにはLIMITを使います。先程のcategoryテーブルから取得する件数を制限してみましょう。

```sql
SELECT
  *
FROM
  category
LIMIT
  5
;
```
---

# LIMIT 概要

|category_id|name|last_update|
|---|---|---|
|1|Action      | 2006-02-15 09:46:27 |
|2|Animation   | 2006-02-15 09:46:27 |
|3|Children    | 2006-02-15 09:46:27 |
|4|Classics    | 2006-02-15 09:46:27 |
|5|Comedy      | 2006-02-15 09:46:27 |

このように取得件数を制限することが出来ます。

---
# LIMIT 注意事項

ここで非常に大事な注意ですが、LIMITは今後扱うWHEREやORDER BYなど諸々の操作の後に作用します。LIMITを追加したから指定した件数だけ取得して並び替えできてるよねと思わないように注意してください。LIMITはあくまでSELECTするデータが確定してから取得する件数を制限するためのものです。複雑なSQLの最後にLIMITをつけてもDBに発行されるクエリが軽くなるわけではありません。クライアント側が受け取るデータが少なくてクライアント側にとって優しくなるだけでDBには優しくなっていないので注意してください。

とりあえず100件だけ取得してデータを眺めてみたいけど、ソートもしたいんだよって場合はまず100件取得して、その後ソートするようにしてあげましょう。その方法はまた別の会で扱います。

---

# 自分でやってみよう

LIMIT句を指定して任意のテーブルからほしい行数だけデータを取得してみましょう。件数以上をLIMITに指定するなど色々試してみてください。

---

# おまけ

## テーブル一覧と件数を取得

例によってPostgreSQL専用です。where使っちゃってるじゃんってツッコミは受け付けません。。。

```sql
select relname, n_live_tup from pg_stat_user_tables where schemaname='public';
```

## 文字コード確認
```sql
\encoding
```
---

# おまけ

## UTC時刻の取得・ローカル時刻の取得

```sql
SELECT
  LOCALTIMESTAMP AS local_time
  , CURRENT_TIMESTAMP AT TIME ZONE 'UTC' AS utc_time;
```

## timezone確認
```sql
show timezone;
```
